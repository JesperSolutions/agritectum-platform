rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getPermissionLevel() {
      // Try to get permission level from custom claims first
      // Fallback: check user document in Firestore
      return request.auth.token.permissionLevel != null 
        ? request.auth.token.permissionLevel
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissionLevel != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissionLevel
          : 0);
    }
    
    function getUserBranchId() {
      // Try to get branchId from custom claims first
      // Fallback: check user document in Firestore
      return request.auth.token.branchId != null 
        ? request.auth.token.branchId
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.branchId
          : "");
    }
    
    function hasBranchAccess(branchId) {
      // Helper to check if user has access to a branch (handles null/empty branchId)
      let userBranchId = getUserBranchId();
      return userBranchId == branchId || userBranchId == "main" || isSuperadmin();
    }
    
    function getUserRole() {
      // Try to get role from custom claims first
      // Fallback: check user document in Firestore
      return request.auth.token.role != null
        ? request.auth.token.role
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
          : "");
    }
    
    function isSuperadmin() {
      return isAuthenticated() && (getUserRole() == 'superadmin' || getPermissionLevel() >= 2);
    }
    
    function isBranchAdmin() {
      return isAuthenticated() && (getUserRole() == 'branchAdmin' || getPermissionLevel() >= 1);
    }
    
    function isInspector() {
      return isAuthenticated() && (getUserRole() == 'inspector' || getPermissionLevel() == 0);
    }
    
    function isCustomer() {
      return isAuthenticated() && (getUserRole() == 'customer' || getPermissionLevel() == -1);
    }
    
    function getUserType() {
      // Try to get userType from custom claims first
      // Fallback: check user document in Firestore
      return request.auth.token.userType != null
        ? request.auth.token.userType
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType
          : "internal");
    }
    
    function getUserCompanyId() {
      // Try to get companyId from custom claims first
      // Fallback: check user document in Firestore
      return request.auth.token.companyId != null
        ? request.auth.token.companyId
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
          : "");
    }
    
    // Helper function to check if user is authenticated (fallback for users without custom claims)
    function isAuthenticatedUser() {
      return isAuthenticated();
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Allow branch admins and superadmins to create users in their branch
      // Allow customers to create their own account
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isCustomer() && request.auth.uid == userId && request.resource.data.userType == "customer")
      );
      
      // Allow branch admins and superadmins to update users in their branch
      // Allow customers to update their own profile
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        // Allow authenticated users to update their own document
        (isAuthenticatedUser() && request.auth.uid == userId)
      );
      
      // Allow authenticated users to delete users
      allow delete: if isAuthenticated();
    }
    
    // Branches collection
    match /branches/{branchId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (getUserBranchId() == branchId || getUserBranchId() == "main")) ||
        (isInspector() && (getUserBranchId() == branchId || getUserBranchId() == "main"))
      );
      allow write: if isSuperadmin();
      
      // Employees subcollection
      match /employees/{employeeId} {
        allow read: if isAuthenticated() && (
          isSuperadmin() ||
          (isBranchAdmin() && (getUserBranchId() == branchId || getUserBranchId() == "main")) ||
          (isInspector() && (getUserBranchId() == branchId || getUserBranchId() == "main"))
        );
        allow create: if isAuthenticated() && (
          isSuperadmin() ||
          (isBranchAdmin() && (getUserBranchId() == branchId || getUserBranchId() == "main"))
        );
        allow update: if isAuthenticated() && (
          isSuperadmin() ||
          (isBranchAdmin() && (getUserBranchId() == branchId || getUserBranchId() == "main"))
        );
        allow delete: if isAuthenticated();
      }
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Allow public read access for customer reports (when isPublic is true)
      allow read: if resource.data.isPublic == true;
      
      // Allow customer read access for their own reports (by customerId or companyId)
      allow read: if isAuthenticated() && isCustomer() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.customerId == getUserCompanyId() ||
        resource.data.companyId == getUserCompanyId()
      );
      
      // CRITICAL FIX: Allow customers to read reports for buildings they own
      allow read: if isAuthenticated() && isCustomer() && 
        resource.data.buildingId != null &&
        exists(/databases/$(database)/documents/buildings/$(resource.data.buildingId)) &&
        (
          get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == request.auth.uid ||
          get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == getUserCompanyId() ||
          (get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.companyId != null && 
           get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.companyId == getUserCompanyId())
        );
      
      // Allow authenticated read access for internal users
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Create requires branch match and creator match; allow main branch users across branches
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        (
          request.resource.data.branchId == getUserBranchId() ||
          getUserBranchId() == "main"
        ) &&
        // Basic required fields to prevent malformed docs
        request.resource.data.keys().hasAll(["customerName", "customerAddress", "inspectionDate", "branchId", "createdBy"]);
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && resource.data.createdBy == request.auth.uid && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      // Create requires branch match and creator match; allow main branch users across branches
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        (
          request.resource.data.branchId == getUserBranchId() ||
          getUserBranchId() == "main"
        ) &&
        // Basic required fields - using actual field names from Customer interface (name, address)
        request.resource.data.keys().hasAll(["name", "branchId", "createdBy"]) &&
        (isSuperadmin() || isBranchAdmin());
      // Only admins can update customers
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      // Only admins can delete customers
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Customer invitations collection - for customer signup links
    match /customerInvitations/{invitationId} {
      // Public read for token validation during signup (no auth required)
      // This allows the signup page to validate the token before the user has an account
      allow read: if true;
      
      // Only branch admins and superadmins can create invitations
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      ) && request.resource.data.createdBy == request.auth.uid;
      
      // Update allowed for marking invitation as used (during signup)
      // or by the admin who created it
      allow update: if true;
      
      // Only admins can delete invitations
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      // Superadmin can read all appointments
      // Branch admins can read appointments in their branch
      // Inspectors can read only their assigned appointments
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && resource.data.assignedInspectorId == request.auth.uid)
      );
      
      // Superadmin and branch admins can create appointments
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      ) && request.resource.data.createdBy == request.auth.uid;
      
      // Superadmin and branch admins can update appointments in their branch
      // Inspectors can update their own appointment status and notes
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && resource.data.assignedInspectorId == request.auth.uid)
      );
      
      // Only superadmin and branch admins can delete appointments
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Email logs collection
    match /emailLogs/{emailLogId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && resource.data.sentBy == request.auth.uid) ||
        (isInspector() && resource.data.sentBy == request.auth.uid)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.sentBy == request.auth.uid;
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        resource.data.sentBy == request.auth.uid
      );
      allow delete: if isSuperadmin();
    }

    // reportAccessLogs collection - ADMIN ONLY
    match /reportAccessLogs/{logId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
      allow create: if true; // Allow public access logging
      allow update, delete: if false; // No updates or deletes allowed
    }
    
    // Mail collection (Trigger Email extension) - ALLOW AUTHENTICATED USERS TO CREATE
    match /mail/{mailId} {
      // Allow authenticated users to create email documents for Trigger Email extension
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin() ||
        isInspector()
      );
      // Restrict read/update/delete for security
      allow read, update, delete: if false;
    }
    
    // Mail status collection - EXTENSION ONLY
    match /mail-status/{statusId} {
      // Only Trigger Email extension can write
      allow read, write: if false;
    }
    
    // Email templates collection (Trigger Email extension)
    match /mail-templates/{templateId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin() ||
        isInspector()
      );
      allow create: if isSuperadmin();
      allow update: if isSuperadmin();
      allow delete: if isSuperadmin();
    }
    
    // Mail suppressions collection - ADMIN ONLY
    match /mail-suppressions/{suppressionId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Suppression logs collection - ADMIN ONLY
    match /suppression-logs/{logId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Mail events collection - ADMIN ONLY
    match /mail-events/{eventId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Email logs collection - ADMIN ONLY
    match /email-logs/{logId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin()
      );
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can create notifications for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own notifications (mark as read, etc.)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Email preferences collection
    match /emailPreferences/{email} {
      // Users can read and write their own email preferences
      allow read, write: if isAuthenticated() && request.auth.token.email == email;
    }

    // Employees collection
    match /employees/{employeeId} {
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      allow delete: if isAuthenticated();
    }
    
    // Offers collection
    match /offers/{offerId} {
      // Public read access for customer acceptance (when offer is pending/awaiting_response)
      allow read: if resource.data.status in ['pending', 'awaiting_response'] && 
        resource.data.publicLink != null;
      
      // Allow customer read access for their own offers (by customerId or companyId)
      allow read: if isAuthenticated() && isCustomer() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.customerId == getUserCompanyId() ||
        resource.data.companyId == getUserCompanyId()
      );
      
      // CRITICAL FIX: Allow customers to read offers for reports linked to buildings they own
      allow read: if isAuthenticated() && isCustomer() && 
        resource.data.reportId != null &&
        exists(/databases/$(database)/documents/reports/$(resource.data.reportId)) &&
        get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId != null &&
        exists(/databases/$(database)/documents/buildings/$(get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId)) &&
        (
          get(/databases/$(database)/documents/buildings/$(get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId)).data.customerId == request.auth.uid ||
          get(/databases/$(database)/documents/buildings/$(get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId)).data.customerId == getUserCompanyId() ||
          (get(/databases/$(database)/documents/buildings/$(get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId)).data.companyId != null && 
           get(/databases/$(database)/documents/buildings/$(get(/databases/$(database)/documents/reports/$(resource.data.reportId)).data.buildingId)).data.companyId == getUserCompanyId())
        );
      
      // Authenticated read access for internal users
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && resource.data.createdBy == request.auth.uid)
      );
      
      // Create offers - authenticated users in their branch
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      ) && request.resource.data.createdBy == request.auth.uid;
      
      // Update offers - branch admins and superadmins
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && resource.data.createdBy == request.auth.uid && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Delete offers - branch admins and superadmins only
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Customers can read their own companies
      allow read: if isAuthenticated() && (
        isCustomer() && (
          resource.data.id == getUserCompanyId() ||
          // Allow if customer's user document has this companyId
          request.auth.uid != null
        ) ||
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Only internal users can create companies
      allow create: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        ) &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Only internal users can update companies
      allow update: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        );
      
      // Only internal users can delete companies
      allow delete: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        );
    }
    
    // Buildings collection
    match /buildings/{buildingId} {
      // Customers can read their own buildings (by customerId matching uid or companyId)
      allow read: if isAuthenticated() && (
        isCustomer() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.customerId == getUserCompanyId() ||
          (resource.data.companyId != null && resource.data.companyId == getUserCompanyId())
        ) ||
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Customers can create buildings linked to their account
      // Internal users can create buildings in their branch
      allow create: if isAuthenticated() && (
        (isCustomer() && (
          request.resource.data.customerId == request.auth.uid ||
          request.resource.data.customerId == getUserCompanyId() ||
          (request.resource.data.companyId != null && request.resource.data.companyId == getUserCompanyId())
        )) ||
        (isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")))
      ) &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Customers can update their own buildings
      // Internal users can update buildings in their branch
      allow update: if isAuthenticated() && (
        (isCustomer() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.customerId == getUserCompanyId() ||
          (resource.data.companyId != null && resource.data.companyId == getUserCompanyId())
        )) ||
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Customers can delete their own buildings
      // Internal users can delete buildings in their branch
      allow delete: if isAuthenticated() && (
        (isCustomer() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.customerId == getUserCompanyId() ||
          (resource.data.companyId != null && resource.data.companyId == getUserCompanyId())
        )) ||
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Scheduled Visits collection (renamed from appointments)
    match /scheduledVisits/{visitId} {
      // Customers can read visits for their buildings/companies
      allow read: if isAuthenticated() && (
        (isCustomer() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.customerId == getUserCompanyId() ||
          (resource.data.buildingId != null && 
           exists(/databases/$(database)/documents/buildings/$(resource.data.buildingId)) &&
           (get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == request.auth.uid ||
            get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == getUserCompanyId())) ||
          (resource.data.companyId != null && resource.data.companyId == getUserCompanyId())
        )) ||
        isSuperadmin() ||
        (isBranchAdmin() && (getUserBranchId() != "" && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))) ||
        (isInspector() && (getUserBranchId() != "" && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")))
      );
      
      // Only internal users can create scheduled visits
      allow create: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        ) && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Only internal users can update scheduled visits
      // Customers cannot modify visits (read-only)
      allow update: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
          (isInspector() && resource.data.assignedInspectorId == request.auth.uid)
        );
      
      // Only internal users can delete scheduled visits
      allow delete: if isAuthenticated() && 
        !isCustomer() && (
          isSuperadmin() ||
          (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        );
    }
    
    // Rejected Orders collection
    match /rejectedOrders/{orderId} {
      // Branch admins and superadmins can read rejected orders in their branch
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Only system (via Cloud Functions) or branch admins can create rejected orders
      allow create: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Only superadmins can update or delete rejected orders
      allow update, delete: if isSuperadmin();
    }
    
    // ESG Service Reports collection
    match /esgServiceReports/{reportId} {
      // Allow public read access if report is public (no authentication required)
      allow get: if resource.data.isPublic == true;
      
      // Allow public list queries for public reports (needed for publicLinkId queries)
      allow list: if true;
      
      // Allow customer read access for ESG reports linked to their buildings
      allow read: if isAuthenticated() && isCustomer() && (
        // Check if the building belongs to the customer
        (resource.data.buildingId != null && 
         exists(/databases/$(database)/documents/buildings/$(resource.data.buildingId)) &&
         (get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == request.auth.uid ||
          get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == getUserCompanyId()))
      );
      
      // Allow authenticated read access for branch managers, inspectors, and superadmins
      allow read: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Allow branch managers and superadmins to create reports
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid &&
        (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main") &&
        // Basic required fields validation
        request.resource.data.keys().hasAll(["buildingId", "branchId", "roofSize", "divisions", "isPublic"]);
      
      // Allow branch managers and superadmins to update reports
      allow update: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Allow branch managers and superadmins to delete reports
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
    
    // Service Agreements collection
    match /serviceAgreements/{agreementId} {
      // Allow public read access if agreement is public (no authentication required)
      allow get: if resource.data.isPublic == true;
      
      // Customers can read agreements linked to their account
      allow get: if isAuthenticated() && 
        isCustomer() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.customerId == getUserCompanyId() ||
          (resource.data.buildingId != null && 
           exists(/databases/$(database)/documents/buildings/$(resource.data.buildingId)) &&
           (get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == request.auth.uid ||
            get(/databases/$(database)/documents/buildings/$(resource.data.buildingId)).data.customerId == getUserCompanyId())) ||
          (resource.data.companyId != null && resource.data.companyId == getUserCompanyId())
        );
      
      // Allow authenticated read access for admins
      // For single document reads, check branchId match
      allow get: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main")) ||
        (isInspector() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
      
      // Allow list queries for branch admins, inspectors, and superadmins
      // Customers can list their own agreements
      allow list: if isAuthenticated() && (
        isSuperadmin() ||
        isBranchAdmin() ||
        isInspector() ||
        isCustomer()
      );
      
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid &&
        (request.resource.data.branchId == getUserBranchId() || getUserBranchId() == "main");
      
      // Allow public update only for acceptance fields, and only if agreement is public and not already accepted
      allow update: if (
        // Public acceptance update
        (resource.data.isPublic == true && 
         !resource.data.acceptedAt &&
         request.resource.data.isPublic == true &&
         request.resource.data.acceptedAt != null &&
         request.resource.data.acceptedBy != null &&
         request.resource.data.acceptedByEmail != null &&
         // Ensure only acceptance fields are being updated
         request.resource.data.customerId == resource.data.customerId &&
         request.resource.data.branchId == resource.data.branchId &&
         request.resource.data.createdBy == resource.data.createdBy)
      ) || (
        // Authenticated admin updates
        isAuthenticated() && (
          isSuperadmin() ||
          (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
        )
      );
      
      allow delete: if isAuthenticated() && (
        isSuperadmin() ||
        (isBranchAdmin() && (resource.data.branchId == getUserBranchId() || getUserBranchId() == "main"))
      );
    }
  }
}